@* ========================================
   Edit.cshtml
   Task editing form modal
   
   Purpose:
   - Allows editing existing task properties
   - Pre-populates form with current task data
   - Updates: title, category, deadline, energy cost, description
   - Preserves task status during edit
   - Compact modal matching Create.cshtml design
   ======================================== *@
@model BatteryWorkflowMVC.ViewModels.TaskFormViewModel

<div class="task-modal-container" id="taskModalOverlay">
<div class="task-modal-content" role="dialog" aria-labelledby="editTaskTitle" aria-modal="true">
    <!-- Compact Modal Header -->
    <div class="task-modal-header">
        <div>
            <h3 id="editTaskTitle">Edit Task</h3>
            <p class="task-modal-subtitle">Update task details and settings</p>
        </div>
        <a asp-action="Index" 
           class="task-modal-close" 
           aria-label="Close dialog"
           tabindex="0"
           role="button">
            <i data-lucide="x" class="w-5 h-5"></i>
        </a>
    </div>

    <!-- Compact Modal Body -->
    <div class="task-modal-body">
        <form asp-action="Edit" class="task-form-compact" id="editTaskForm">
            @* Anti-forgery token for CSRF protection *@
            @Html.AntiForgeryToken()
            
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="Status" />
            
            <!-- Task Title (Full Width) -->
            <div class="form-field">
                <label asp-for="Title" class="form-label">
                    <span>Title</span>
                    <span class="tooltip">
                        <i data-lucide="info" class="w-3 h-3 cursor-help"></i>
                        <span class="tooltip-text">Update task name</span>
                    </span>
                </label>
                <input asp-for="Title" 
                       class="form-input" 
                       required 
                       aria-required="true"
                       aria-describedby="titleError" />
                <span asp-validation-for="Title" id="titleError" class="validation-error"></span>
            </div>

            <!-- Category & Deadline (Two Columns) -->
            <div class="task-form-row">
                <div class="form-field">
                    <label asp-for="Category" class="form-label">
                        <span>Category</span>
                        <span class="tooltip">
                            <i data-lucide="info" class="w-3 h-3 cursor-help"></i>
                            <span class="tooltip-text">Change category</span>
                        </span>
                    </label>
                    <div class="form-select-wrapper">
                        <select asp-for="Category" class="form-select" aria-label="Task category">
                            @foreach(var cat in BatteryWorkflowMVC.ViewModels.TaskFormViewModel.Categories) {
                                <option value="@cat">@cat</option>
                            }
                        </select>
                        <i data-lucide="chevron-down" class="form-select-icon"></i>
                    </div>
                </div>
                
                <div class="form-field">
                    <label asp-for="Deadline" class="form-label">
                        <span>Deadline</span>
                        <span class="tooltip">
                            <i data-lucide="info" class="w-3 h-3 cursor-help"></i>
                            <span class="tooltip-text">Update target date</span>
                        </span>
                    </label>
                    <input asp-for="Deadline" 
                           type="date" 
                           class="form-input"
                           aria-label="Task deadline" />
                </div>
            </div>

            <!-- Energy Cost Slider -->
            <div class="form-field energy-control">
                <div class="energy-label-row">
                    <label class="form-label">
                        <span>Energy cost</span>
                        <span class="tooltip">
                            <i data-lucide="info" class="w-3 h-3 cursor-help"></i>
                            <span class="tooltip-text">Adjust effort estimate</span>
                        </span>
                    </label>
                    <span id="energyValue" class="energy-value">@Model.EnergyCost</span>
                </div>
                <input asp-for="EnergyCost" 
                       type="range" 
                       min="5" 
                       max="100" 
                       step="5" 
                       class="energy-slider" 
                       aria-label="Energy cost slider"
                       aria-valuemin="5"
                       aria-valuemax="100"
                       aria-valuenow="@Model.EnergyCost"
                       oninput="document.getElementById('energyValue').innerText = this.value; this.setAttribute('aria-valuenow', this.value);" />
                <div class="energy-scale">
                    <span>Low (5)</span>
                    <span>Med (50)</span>
                    <span>High (100)</span>
                </div>
            </div>

            <!-- Description -->
            <div class="form-field">
                <label asp-for="Description" class="form-label">
                    <span>Description</span>
                    <span class="tooltip">
                        <i data-lucide="info" class="w-3 h-3 cursor-help"></i>
                        <span class="tooltip-text">Update task notes</span>
                    </span>
                </label>
                <textarea asp-for="Description" 
                          class="form-textarea" 
                          aria-label="Task description"></textarea>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="task-submit-btn" aria-label="Save changes">
                <i data-lucide="save" class="w-5 h-5"></i>
                <span>Save Changes</span>
            </button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        
        const form = document.getElementById('editTaskForm');
        const modal = document.querySelector('.task-modal-content');
        const closeBtn = modal.querySelector('.task-modal-close');
        
        // Focus trap
        const focusableElements = modal.querySelectorAll(
            'a[href], button, textarea, input, select, [tabindex]:not([tabindex="-1"])'
        );
        const firstFocusable = focusableElements[0];
        const lastFocusable = focusableElements[focusableElements.length - 1];
        
        modal.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                if (e.shiftKey) {
                    if (document.activeElement === firstFocusable) {
                        e.preventDefault();
                        lastFocusable.focus();
                    }
                } else {
                    if (document.activeElement === lastFocusable) {
                        e.preventDefault();
                        firstFocusable.focus();
                    }
                }
            }
            
            // ESC to close
            if (e.key === 'Escape') {
                window.location.href = closeBtn.href;
            }
        });
        
        // Track form changes
        form.addEventListener('input', () => form.dataset.modified = 'true');
        form.addEventListener('change', () => form.dataset.modified = 'true');
        
        // Validate on submit
        form.addEventListener('submit', async (e) => {
            const title = form.querySelector('input[name="Title"]').value.trim();
            if (!title) {
                e.preventDefault();
                const titleInput = form.querySelector('input[name="Title"]');
                titleInput.focus();
                titleInput.setAttribute('aria-invalid', 'true');
                return false;
            }
            delete form.dataset.modified;
        });
        
        // Click outside to close
        const overlay = document.getElementById('taskModalOverlay');
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                window.location.href = closeBtn.href;
            }
        });
    });
</script>
</div>