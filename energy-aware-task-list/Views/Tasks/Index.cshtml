@model BatteryWorkflowMVC.ViewModels.DashboardViewModel
@{
    var batteryColor = Model.Battery.Percentage > 50 ? "from-[#A594F9] to-[#8B78E6]" :
                       Model.Battery.Percentage > 20 ? "from-yellow-400 to-orange-300" :
                       "from-red-400 to-rose-400";
}

<!-- Battery Meter -->
<div class="glass-effect rounded-[2rem] p-6 shadow-lg relative overflow-hidden group hover-lift card-enter" style="border-color: var(--border-color); box-shadow: 0 4px 12px var(--shadow-color);">
    <div class="absolute -right-10 -top-10 w-40 h-40 rounded-full opacity-20 blur-3xl @(Model.Battery.Percentage > 20 ? "bg-[#A594F9]" : "bg-red-400")"></div>
    
    <div class="flex justify-between items-end mb-5 relative z-10">
        <div>
           <div class="text-xs font-bold uppercase tracking-widest mb-1 flex items-center gap-1" style="color: var(--text-secondary);">
             <i data-lucide="moon" class="w-3 h-3"></i> Energy Level
           </div>
           <div class="flex items-baseline gap-2">
             <span class="text-5xl font-black" style="color: var(--text-primary);">@Model.Battery.Percentage%</span>
             <span class="text-sm font-semibold" style="color: var(--text-muted);">Available</span>
           </div>
        </div>
        <div class="text-right">
             <label class="text-xs font-bold uppercase tracking-wider mb-2 block" style="color: var(--text-secondary);">Daily Budget</label>
             <span class="font-black text-xl" style="color: var(--text-primary);">@Model.Battery.DailyBudget</span>
             <p class="text-[10px] mt-1 font-bold" style="color: var(--text-muted);">Resets at @Model.Battery.ResetTime</p>
        </div>
    </div>

    <div class="h-10 w-full rounded-2xl overflow-hidden relative shadow-inner p-1.5" style="background: var(--input-bg); border: 1px solid var(--border-color);">
        <div class="energy-bar h-full rounded-xl shadow-sm bg-gradient-to-r @batteryColor" style="width: @Model.Battery.Percentage%"></div>
    </div>
    
    <div class="mt-3 flex justify-between text-xs font-semibold" style="color: var(--text-secondary);">
        <span><i data-lucide="zap" class="w-3 h-3 inline"></i> Used: @Model.Battery.EnergyUsed</span>
        <span>Max: @Model.Battery.DailyBudget</span>
    </div>
</div>

<!-- Add Task Button -->
<a asp-action="Create" class="btn-animate w-full py-4 text-white rounded-2xl font-bold text-base transition-all shadow-lg flex items-center justify-center gap-2" style="background: var(--accent-secondary); box-shadow: 0 4px 12px var(--shadow-color);">
    <i data-lucide="plus" class="w-5 h-5"></i> Add New Task
</a>

<!-- Filters -->
<div class="flex flex-col gap-4">
    <div class="flex gap-3">
        <!-- Search -->
        <form method="get" class="relative flex-1">
            <input type="hidden" name="status" value="@Model.CurrentFilter" />
            <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5" style="color: var(--accent-primary);"></i>
            <input type="text" name="search" value="@Model.SearchQuery" placeholder="Search tasks..." class="w-full pl-12 pr-4 py-3.5 rounded-2xl border-2 font-semibold shadow-sm font-body smooth-transition" style="background: var(--card-bg); border-color: transparent; color: var(--text-primary);" onblur="this.form.submit()" />
        </form>
        <!-- Tired Mode Toggle -->
        <button id="tiredModeToggle" class="px-4 py-3.5 rounded-2xl border-2 flex items-center gap-2 text-sm font-bold shadow-sm smooth-transition hover-lift" style="background: var(--card-bg); border-color: transparent; color: var(--accent-primary);">
            <i data-lucide="battery-warning" class="w-5 h-5"></i>
            <span class="hidden sm:inline">Tired Mode</span>
        </button>
    </div>

    <!-- Status Tabs -->
    <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide px-1">
        @foreach (var status in new[] { "Backlog", "Active", "Completed", "All" })
        {
            var isActive = Model.CurrentFilter == status;
            <a asp-action="Index" asp-route-status="@status" class="px-4 py-2 rounded-xl text-sm font-bold whitespace-nowrap smooth-transition shadow-sm hover-lift" style="@(isActive ? "background: var(--accent-primary); color: white; box-shadow: 0 4px 12px var(--shadow-color);" : "background: var(--card-bg); color: var(--accent-primary);")">
                @status
            </a>
        }
    </div>
</div>

<!-- Task List -->
<div class="space-y-4" id="taskListContainer" data-remaining-energy="@Model.RemainingEnergy">
    @if (!Model.Tasks.Any())
    {
        <div class="text-center py-16 rounded-[2rem] card-enter" style="background: var(--card-bg); border: 1px solid var(--border-color);">
             <div class="w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-4" style="background: var(--input-bg); color: var(--accent-primary);">
               <i data-lucide="filter" class="w-10 h-10"></i>
             </div>
             <p class="font-bold text-lg" style="color: var(--text-primary);">No tasks found</p>
        </div>
    }
    else 
    {
        @foreach (var task in Model.Tasks)
        {
            var energyLevel = BatteryWorkflowMVC.Models.EnergyLevel.GetLevel(task.EnergyCost);
            var isCompleted = task.Status == BatteryWorkflowMVC.Models.TaskStatus.Completed;
            var isActive = task.Status == BatteryWorkflowMVC.Models.TaskStatus.Active;
            
            <div class="task-card group relative rounded-3xl p-5 border smooth-transition hover-lift card-enter @(isCompleted ? "opacity-60" : "")" 
                style="background: var(--card-bg); @(isActive ? $"border-color: var(--accent-primary); box-shadow: 0 4px 12px var(--shadow-color);" : "border-color: transparent; box-shadow: 0 1px 3px var(--shadow-color);")"
                data-energy-cost="@task.EnergyCost"
                data-status="@task.Status">
                
                <div class="flex justify-between items-start gap-4">
                    <div class="mt-1">
                        @if (isActive)
                        {
                            <form asp-action="UpdateStatus" asp-route-id="@task.Id" asp-route-newStatus="Completed" method="post">
                                <button type="submit" class="smooth-transition hover-scale" style="color: var(--accent-primary);"><i data-lucide="check-circle-2" class="w-7 h-7"></i></button>
                            </form>
                        }
                        else if (isCompleted)
                        {
                            <form asp-action="UpdateStatus" asp-route-id="@task.Id" asp-route-newStatus="Backlog" method="post">
                                <button type="submit" class="text-emerald-400 hover:text-emerald-500 smooth-transition hover-scale"><i data-lucide="check-circle-2" class="w-7 h-7 fill-emerald-50"></i></button>
                            </form>
                        }
                        else
                        {
                            <form asp-action="UpdateStatus" asp-route-id="@task.Id" asp-route-newStatus="Active" method="post">
                                <button type="submit" class="smooth-transition hover-scale" style="color: var(--text-secondary);" @(task.EnergyCost > Model.RemainingEnergy ? "disabled title='Not enough energy'" : "")>
                                    <i data-lucide="play-circle" class="w-7 h-7"></i>
                                </button>
                            </form>
                        }
                    </div>

                    <div class="flex-1 min-w-0 pt-0.5">
                        <div class="flex items-center gap-2 mb-2">
                            <h3 class="font-bold text-lg truncate @(isCompleted ? "line-through" : "")" style="color: @(isCompleted ? "var(--text-muted)" : "var(--text-primary)");">@task.Title</h3>
                            <a asp-action="Edit" asp-route-id="@task.Id" class="opacity-0 group-hover:opacity-100 smooth-transition p-1.5 rounded-lg hover-lift" style="color: var(--accent-primary);"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></a>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 text-xs font-body">
                            <span class="px-2.5 py-1 rounded-full font-bold border flex items-center gap-1 @energyLevel.CssClass @energyLevel.BorderClass">
                                <i data-lucide="zap" class="w-3 h-3"></i> @task.EnergyCost
                            </span>
                            <span class="px-2.5 py-1 rounded-full border font-semibold" style="color: var(--text-muted); background: var(--input-bg); border-color: var(--border-color);">@task.Category</span>
                        </div>
                        @if (!string.IsNullOrEmpty(task.Description)) {
                             <p class="mt-3 text-sm font-body line-clamp-2 p-3 rounded-xl" style="color: var(--text-muted); background: var(--input-bg);">@task.Description</p>
                        }
                    </div>

                    <form asp-action="Delete" asp-route-id="@task.Id" method="post" onsubmit="return confirmDelete(event, this);">
                        <button type="submit" class="opacity-0 group-hover:opacity-100 hover:text-rose-400 smooth-transition p-2 rounded-full" style="color: var(--text-secondary); background: var(--input-bg);"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </form>
                </div>
            </div>
        }
    }
</div>

<!-- Settings Modal (Hidden by default) -->
<div id="settingsModal" class="modal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h3 class="modal-title">Settings</h3>
            <button type="button" onclick="toggleSettingsModal()" class="modal-close">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <form asp-action="UpdateSettings" method="post" class="space-y-6">
            <div class="p-5 rounded-2xl" style="background: var(--input-bg); border: 1px solid var(--border-color);">
                <label class="text-xs font-bold uppercase block mb-3" style="color: var(--text-secondary);">Daily Energy Budget</label>
                <input type="number" name="dailyBudget" value="@Model.Battery.DailyBudget" class="w-full text-xl font-bold p-3 rounded-xl border-2 text-center smooth-transition" style="background: var(--card-bg); color: var(--text-primary); border-color: transparent;" />
                <p class="text-xs mt-2" style="color: var(--text-muted);">Set your total daily energy budget for tasks</p>
            </div>
            <div class="p-5 rounded-2xl" style="background: var(--input-bg); border: 1px solid var(--border-color);">
                <label class="text-xs font-bold uppercase block mb-3" style="color: var(--text-secondary);">Daily Reset Time</label>
                <input type="time" name="resetTime" value="@Model.Battery.ResetTime" class="w-full text-xl font-bold p-3 rounded-xl border-2 text-center smooth-transition" style="background: var(--card-bg); color: var(--text-primary); border-color: transparent;" />
                <p class="text-xs mt-2" style="color: var(--text-muted);">Choose when your energy resets each day</p>
            </div>
            <button type="submit" class="btn-animate w-full py-3 text-white font-bold rounded-xl shadow-lg" style="background: var(--accent-secondary);">
                Save Changes
            </button>
        </form>
    </div>
</div>

<script>
    function toggleSettingsModal() {
        modalManager.open('settingsModal');
    }
    
    async function confirmDelete(event, form) {
        event.preventDefault();
        const confirmed = await confirmAction('Are you sure you want to delete this task?', 'Delete Task');
        if (confirmed) {
            form.submit();
        }
        return false;
    }
    
    // Re-initialize lucide icons after page load
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
    });
</script>