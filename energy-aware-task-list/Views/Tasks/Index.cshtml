@* ========================================
   Index.cshtml
   Main dashboard view with battery meter and task list
   
   Purpose:
   - Displays battery meter showing remaining energy percentage
   - Lists tasks filtered by status (Backlog/Active/Completed/All)
   - Provides "tired mode" toggle to hide high-energy tasks
   - Includes settings modal for budget and reset time configuration
   - Handles task status updates and deletions
   ======================================== *@
@model BatteryWorkflowMVC.ViewModels.DashboardViewModel
@{
    var batteryColor = Model.Battery.Percentage > 50 ? "from-[#A594F9] to-[#8B78E6]" :
                       Model.Battery.Percentage > 20 ? "from-yellow-400 to-orange-300" :
                       "from-red-400 to-rose-400";
}

<!-- Battery Meter -->
<div class="glass-effect rounded-[2rem] p-6 shadow-lg relative overflow-hidden group hover-lift card-enter" style="border-color: var(--border-color); box-shadow: 0 4px 12px var(--shadow-color);">
    <div class="absolute -right-10 -top-10 w-40 h-40 rounded-full opacity-20 blur-3xl @(Model.Battery.Percentage > 20 ? "bg-[#A594F9]" : "bg-red-400")"></div>
    
    <div class="flex justify-between items-end mb-5 relative z-10">
        <div>
           <div class="text-xs font-bold tracking-wide mb-1 flex items-center gap-1" style="color: var(--text-secondary);">
             <i data-lucide="moon" class="w-3 h-3"></i> Energy level
             <span class="tooltip">
                 <i data-lucide="info" class="w-3.5 h-3.5 cursor-help"></i>
                 <span class="tooltip-text" style="width: 200px; white-space: normal;">Your current available energy points for the day. Active tasks will reduce this value.</span>
             </span>
           </div>
           <div class="flex items-baseline gap-2">
             <span class="text-5xl font-black" style="color: var(--text-primary);">@Model.Battery.Percentage%</span>
             <span class="text-sm font-semibold" style="color: var(--text-muted);">Available</span>
           </div>
           <p class="helper-text-inline mt-1">@Model.Battery.EnergyUsed of @Model.Battery.DailyBudget points used</p>
        </div>
        <div class="text-right">
             <label class="text-xs font-bold tracking-wide mb-2 flex items-center justify-end gap-1" style="color: var(--text-secondary);">
                 Daily budget
                 <span class="tooltip">
                     <i data-lucide="info" class="w-3.5 h-3.5 cursor-help"></i>
                     <span class="tooltip-text" style="width: 220px; white-space: normal;">The maximum energy points you can spend on tasks each day. Adjust in settings to match your capacity.</span>
                 </span>
             </label>
             <span class="font-black text-xl" style="color: var(--text-primary);">@Model.Battery.DailyBudget</span>
             <p class="text-[10px] mt-1 font-bold" style="color: var(--text-muted);">Resets at @Model.Battery.ResetTime</p>
        </div>
    </div>

    <div class="h-10 w-full rounded-2xl overflow-hidden relative shadow-inner p-1.5" style="background: var(--input-bg); border: 1px solid var(--border-color);">
        <div class="energy-bar h-full rounded-xl shadow-sm bg-gradient-to-r @batteryColor" style="width: @Model.Battery.Percentage%"></div>
    </div>
    
    <div class="mt-3 flex justify-between text-xs font-semibold" style="color: var(--text-secondary);">
        <span><i data-lucide="zap" class="w-3 h-3 inline"></i> Used: @Model.Battery.EnergyUsed</span>
        <span>Max: @Model.Battery.DailyBudget</span>
    </div>
    <p class="helper-text">Track your daily energy and manage tasks based on your capacity</p>
</div>

<!-- Add Task Button -->
<div class="relative">
    <a asp-action="Create" class="btn-animate w-full py-4 text-white rounded-2xl font-bold text-base transition-all shadow-lg flex items-center justify-center gap-2" style="background: var(--accent-secondary); box-shadow: 0 4px 12px var(--shadow-color);">
        <i data-lucide="plus" class="w-5 h-5"></i> Add New Task
    </a>
    <p class="helper-text">Create a new task with title, category, deadline, and energy cost</p>
</div>

<!-- Filters -->
<div class="flex flex-col gap-4">
    <div class="flex gap-3">
        <!-- Search -->
        <form method="get" class="relative flex-1" id="searchForm">
            <input type="hidden" name="status" value="@Model.CurrentFilter" />
            <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5" style="color: var(--accent-primary);"></i>
            <input type="text" 
                   id="searchInput"
                   name="search" 
                   value="@Model.SearchQuery" 
                   placeholder="Search tasks..." 
                   class="w-full pl-12 pr-4 py-3.5 rounded-2xl border-2 font-semibold shadow-sm font-body smooth-transition" 
                   style="background: var(--card-bg); border-color: transparent; color: var(--text-primary);"
                   aria-label="Search tasks"
                   autocomplete="off" />
        </form>
        <!-- Tired Mode Toggle -->
        <div class="tooltip">
            <button id="tiredModeToggle" 
                    class="px-4 py-3.5 rounded-2xl border-2 flex items-center gap-2 text-sm font-bold shadow-sm smooth-transition hover-lift" 
                    style="background: var(--card-bg); border-color: transparent; color: var(--accent-primary);"
                    aria-pressed="false"
                    aria-label="Toggle tired mode to hide high-energy tasks"
                    role="switch">
                <i data-lucide="battery-warning" class="w-5 h-5"></i>
                <span class="hidden sm:inline">Tired Mode</span>
            </button>
            <span class="tooltip-text" style="width: 220px; white-space: normal;">Hide tasks that exceed your remaining energy to focus on what you can accomplish today</span>
        </div>
    </div>

    <!-- Status Tabs -->
    <div class="category-tabs-container">
        <div class="category-tabs-wrapper" role="tablist" aria-label="Task status filter">
            @{
                var categoryDescriptions = new Dictionary<string, string> {
                    { "Backlog", "Unstarted tasks waiting to be activated" },
                    { "Active", "Tasks currently in progress" },
                    { "Completed", "Finished tasks" },
                    { "All", "View all tasks across categories" }
                };
            }
            @foreach (var status in new[] { "Backlog", "Active", "Completed", "All" })
            {
                var isActive = Model.CurrentFilter == status;
                <div class="category-tab">
                    <a href="#" 
                       data-status="@status"
                       data-description="@categoryDescriptions[status]"
                       class="category-tab-link @(isActive ? "active" : "")" 
                       style="@(isActive ? "background: var(--accent-primary); color: white; box-shadow: 0 4px 12px var(--shadow-color);" : "background: var(--card-bg); color: var(--accent-primary);")" 
                       role="tab"
                       aria-selected="@(isActive ? "true" : "false")"
                       aria-label="Filter by @status tasks"
                       tabindex="@(isActive ? "0" : "-1")">
                        @status
                    </a>
                </div>
            }
        </div>
        <!-- Single dynamic description -->
        <p class="category-description-text" id="categoryDescription" style="margin-top: 0.75rem; font-size: 0.8125rem; color: var(--text-secondary); font-weight: 600; text-align: left; padding-left: 0.25rem; transition: opacity 0.3s ease;">
            @categoryDescriptions[Model.CurrentFilter]
        </p>
    </div>
</div>

<!-- Task List -->
<div class="space-y-4" id="taskListContainer" data-remaining-energy="@Model.RemainingEnergy">
    @if (!Model.Tasks.Any())
    {
        <div class="text-center py-16 rounded-[2rem] card-enter" style="background: var(--card-bg); border: 1px solid var(--border-color);">
             <div class="w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-4" style="background: var(--input-bg); color: var(--accent-primary);">
               <i data-lucide="filter" class="w-10 h-10"></i>
             </div>
             <p class="font-bold text-lg" style="color: var(--text-primary);">No tasks found</p>
        </div>
    }
    else 
    {
        @for (int i = 0; i < Model.Tasks.Count; i++)
        {
            var task = Model.Tasks[i];
            var energyLevel = BatteryWorkflowMVC.Models.EnergyLevel.GetLevel(task.EnergyCost);
            var isCompleted = task.Status == BatteryWorkflowMVC.Models.TaskStatus.Completed;
            var isActive = task.Status == BatteryWorkflowMVC.Models.TaskStatus.Active;
            var canStart = task.EnergyCost <= Model.RemainingEnergy;
            var daysAgo = (DateTime.Now - task.CreatedAt).Days;
            var createdText = daysAgo == 0 ? "Today" : daysAgo == 1 ? "Yesterday" : $"{daysAgo}d ago";
            
            <div class="task-card group relative rounded-2xl overflow-hidden smooth-transition hover-lift card-enter @(isCompleted ? "opacity-70" : "")" 
                style="background: var(--card-bg); border: 2px solid @(isActive ? "var(--accent-primary)" : "var(--border-color)"); box-shadow: @(isActive ? "0 8px 20px var(--shadow-color)" : "0 2px 8px var(--shadow-color)"); animation-delay: @(i * 50)ms;"
                data-energy-cost="@task.EnergyCost"
                data-status="@task.Status">
                
                <!-- Active Status Indicator -->
                @if (isActive)
                {
                    <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-[#A594F9] to-[#8B78E6]"></div>
                }
                
                <div class="p-3.5">
                    <!-- Header Section -->
                    <div class="flex items-start gap-2.5 mb-2">
                        <!-- Action Button -->
                        <div class="flex-shrink-0">
                            @if (isActive)
                            {
                                <form asp-action="UpdateStatus" asp-route-id="@task.Id" asp-route-newStatus="Completed" method="post" class="tooltip">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="w-10 h-10 rounded-xl flex items-center justify-center smooth-transition hover-scale" style="background: var(--accent-primary); color: white; box-shadow: 0 4px 12px rgba(165, 148, 249, 0.3);">
                                        <i data-lucide="check" class="w-5 h-5"></i>
                                    </button>
                                    <span class="tooltip-text">Mark as complete</span>
                                </form>
                            }
                            else if (isCompleted)
                            {
                                <form asp-action="UpdateStatus" asp-route-id="@task.Id" asp-route-newStatus="Backlog" method="post" class="tooltip">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="w-10 h-10 rounded-xl flex items-center justify-center smooth-transition hover-scale" style="background: #10b981; color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                                        <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                                    </button>
                                    <span class="tooltip-text">Reopen task</span>
                                </form>
                            }
                            else
                            {
                                <form asp-action="UpdateStatus" asp-route-id="@task.Id" asp-route-newStatus="Active" method="post" class="tooltip" onsubmit="return handleTaskStart(event, this, @task.EnergyCost, @Model.RemainingEnergy);">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="w-10 h-10 rounded-xl flex items-center justify-center smooth-transition hover-scale @(canStart ? "" : "opacity-50 cursor-not-allowed")" style="background: var(--input-bg); color: var(--accent-primary); border: 2px solid var(--border-color);" @(!canStart ? "disabled" : "")>
                                        <i data-lucide="play" class="w-5 h-5"></i>
                                    </button>
                                    <span class="tooltip-text">@(canStart ? "Start task" : $"Need {task.EnergyCost - Model.RemainingEnergy} more energy")</span>
                                </form>
                            }
                        </div>
                        
                        <!-- Task Title & Actions -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between gap-2 mb-1.5">
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-bold text-lg leading-snug mb-0.5 @(isCompleted ? "line-through" : "")" style="color: @(isCompleted ? "var(--text-muted)" : "var(--text-primary)");">
                                        @task.Title
                                    </h3>
                                    <div class="flex items-center gap-1.5 text-xs" style="color: var(--text-muted);">
                                        <span class="tooltip">
                                            <span class="flex items-center gap-1">
                                                <i data-lucide="clock" class="w-3 h-3"></i>
                                                @createdText
                                            </span>
                                            <span class="tooltip-text">Created: @task.CreatedAt.ToString("MMM dd, yyyy")</span>
                                        </span>
                                        @if (isCompleted && task.CompletedAt.HasValue)
                                        {
                                            <span class="tooltip">
                                                <span class="flex items-center gap-1">
                                                    <span>•</span>
                                                    <i data-lucide="check-circle" class="w-3 h-3"></i>
                                                    @task.CompletedAt.Value.ToString("MMM dd")
                                                </span>
                                                <span class="tooltip-text">Completed: @task.CompletedAt.Value.ToString("MMM dd, yyyy")</span>
                                            </span>
                                        }
                                    </div>
                                </div>
                                <div class="flex items-center gap-1.5 opacity-0 group-hover:opacity-100 smooth-transition">
                                    <span class="tooltip">
                                        <a href="/Tasks/Edit/@task.Id" class="task-action-btn task-edit-btn" aria-label="Edit @task.Title" onclick="handleEditClick(event, @task.Id)">
                                            <i data-lucide="pencil" class="w-4 h-4"></i>
                                        </a>
                                        <span class="tooltip-text">Edit task</span>
                                    </span>
                                    <span class="tooltip">
                                        <form asp-action="Delete" asp-route-id="@task.Id" method="post" onsubmit="return confirmDelete(event, this);" class="inline">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="task-action-btn task-delete-btn" aria-label="Delete @task.Title">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </form>
                                        <span class="tooltip-text">Delete task</span>
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Metadata Grid -->
                            <div class="grid grid-cols-2 gap-1.5 mb-2">
                                <span class="tooltip">
                                    <span class="px-2.5 py-1 rounded-lg font-bold text-xs flex items-center gap-1.5 @energyLevel.CssClass @energyLevel.BorderClass" style="border-width: 2px;">
                                        <i data-lucide="zap" class="w-3.5 h-3.5"></i>
                                        @task.EnergyCost
                                    </span>
                                    <span class="tooltip-text">Energy cost: @task.EnergyCost points</span>
                                </span>
                                <span class="tooltip">
                                    <span class="px-2.5 py-1 rounded-lg font-semibold text-xs" style="color: var(--text-primary); background: var(--input-bg); border: 2px solid var(--border-color);">
                                        <i data-lucide="folder" class="w-3 h-3 inline mr-1"></i>
                                        @task.Category
                                    </span>
                                    <span class="tooltip-text">Category: @task.Category</span>
                                </span>
                                @if (task.Deadline.HasValue)
                                {
                                    var isOverdue = task.Deadline.Value < DateTime.Now && !isCompleted;
                                    <span class="tooltip">
                                        <span class="px-2.5 py-1 rounded-lg font-semibold text-xs flex items-center gap-1" style="color: @(isOverdue ? "#ef4444" : "var(--text-muted)"); background: var(--input-bg); border: 2px solid @(isOverdue ? "#ef4444" : "var(--border-color)");">
                                            <i data-lucide="calendar" class="w-3 h-3"></i>
                                            @task.Deadline.Value.ToString("MMM dd")
                                        </span>
                                        <span class="tooltip-text">@(isOverdue ? "Overdue!" : "Deadline: " + task.Deadline.Value.ToString("MMM dd, yyyy"))</span>
                                    </span>
                                }
                                <span class="tooltip">
                                    <span class="px-2.5 py-1 rounded-lg font-semibold text-xs" style="color: var(--text-secondary); background: var(--input-bg); border: 2px solid var(--border-color);">
                                        <i data-lucide="@(isActive ? "play-circle" : isCompleted ? "check-circle-2" : "circle-dashed")" class="w-3 h-3 inline mr-1"></i>
                                        @task.Status
                                    </span>
                                    <span class="tooltip-text">Status: @task.Status</span>
                                </span>
                            </div>
                            
                            <!-- Description Section -->
                            @if (!string.IsNullOrEmpty(task.Description))
                            {
                                <div class="mt-2">
                                    <p class="text-xs font-body leading-relaxed p-2 rounded-lg line-clamp-2" style="color: var(--text-muted); background: var(--input-bg);">
                                        @task.Description
                                    </p>
                                </div>
                            }
                        </div>
                    </div>
                    
                    <!-- Insufficient Energy Warning -->
                    @if (!canStart && !isCompleted && !isActive)
                    {
                        <div class="mt-2 p-2 rounded-lg flex items-center gap-2" style="background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444;">
                            <i data-lucide="alert-circle" class="w-3.5 h-3.5" style="color: #ef4444;"></i>
                            <span class="text-xs font-semibold" style="color: #ef4444;">
                                Need @(task.EnergyCost - Model.RemainingEnergy) more energy to start
                            </span>
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>

<!-- Settings Modal (Hidden by default) -->
<div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsModalTitle">
    <div class="modal-dialog">
        <div class="modal-header">
            <div>
                <h3 id="settingsModalTitle" class="modal-title">Settings</h3>
                <p class="helper-text-inline mt-1">Configure your energy management preferences</p>
            </div>
            <button type="button" onclick="modalManager.close('settingsModal')" class="modal-close" aria-label="Close settings">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <form asp-action="UpdateSettings" method="post" class="space-y-6">
            @Html.AntiForgeryToken()
            <div class="p-5 rounded-2xl" style="background: var(--input-bg); border: 1px solid var(--border-color);">
                <label class="text-xs font-bold block mb-3 flex items-center gap-1" style="color: var(--text-secondary);">
                    Daily energy budget
                    <span class="tooltip">
                        <i data-lucide="info" class="w-3 h-3 cursor-help"></i>
                        <span class="tooltip-text" style="width: 240px; white-space: normal;">Set your maximum daily capacity. Higher budgets allow more tasks, but be realistic about your limits.</span>
                    </span>
                </label>
                <div class="flex items-center gap-3">
                    <button type="button" id="decrementBudget" class="w-12 h-12 rounded-xl font-bold text-2xl flex items-center justify-center smooth-transition hover-lift" style="background: var(--card-bg); color: var(--accent-primary); border: 2px solid var(--border-color);">
                        −
                    </button>
                    <input type="number" id="budgetInput" name="dailyBudget" value="@Model.Battery.DailyBudget" min="10" max="500" step="5" class="flex-1 text-xl font-bold p-3 rounded-xl border-2 text-center smooth-transition" style="background: var(--card-bg); color: var(--text-primary); border-color: transparent;" />
                    <button type="button" id="incrementBudget" class="w-12 h-12 rounded-xl font-bold text-2xl flex items-center justify-center smooth-transition hover-lift" style="background: var(--card-bg); color: var(--accent-primary); border: 2px solid var(--border-color);">
                        +
                    </button>
                </div>
                <p class="helper-text">Set your total daily energy budget for tasks (10-500 points)</p>
            </div>
            <div class="p-5 rounded-2xl" style="background: var(--input-bg); border: 1px solid var(--border-color);">
                <label class="text-xs font-bold block mb-3 flex items-center gap-1" style="color: var(--text-secondary);">
                    Daily reset time
                    <span class="tooltip">
                        <i data-lucide="info" class="w-3 h-3 cursor-help"></i>
                        <span class="tooltip-text" style="width: 220px; white-space: normal;">Choose when your energy resets. Align with your natural rhythm (e.g., 6 AM for morning people).</span>
                    </span>
                </label>
                <input type="time" name="resetTime" value="@Model.Battery.ResetTime" class="w-full text-xl font-bold p-3 rounded-xl border-2 text-center smooth-transition" style="background: var(--card-bg); color: var(--text-primary); border-color: transparent;" />
                <p class="helper-text">Choose when your energy resets each day</p>
            </div>
            <button type="submit" class="btn-animate w-full py-3 text-white font-bold rounded-xl shadow-lg" style="background: var(--accent-secondary);">
                <i data-lucide="save" class="w-4 h-4 inline"></i> Save Changes
            </button>
        </form>
    </div>
</div>

<script>
    // Modal Manager with Full-Screen Blur & Accessibility
    const modalManager = {
        activeModal: null,
        previousFocus: null,
        isTransitioning: false,
        closeDebounceTimer: null,
        
        open(modalId) {
            try {
                if (this.isTransitioning) return;
                
                const modal = document.getElementById(modalId);
                if (!modal) {
                    console.error(`Modal with id '${modalId}' not found`);
                    this.showError('Settings panel not available');
                    return;
                }
                
                if (this.activeModal === modal) return;
                
                this.isTransitioning = true;
                
                // Store current focus to restore later
                this.previousFocus = document.activeElement;
                
                // Prevent body scroll
                document.body.style.overflow = 'hidden';
                
                // Show modal
                modal.classList.add('show');
                modal.setAttribute('aria-hidden', 'false');
                this.activeModal = modal;
                
                // Focus first focusable element
                setTimeout(() => {
                    try {
                        const focusable = modal.querySelectorAll(
                            'button:not([disabled]), [href]:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"]):not([disabled])'
                        );
                        if (focusable.length > 0) {
                            focusable[0].focus();
                        }
                    } catch (e) {
                        console.warn('Could not set modal focus:', e);
                    }
                    this.isTransitioning = false;
                }, 150);
                
                // Add event listeners
                this.addEventListeners(modal);
                
                // Re-initialize lucide icons in modal
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            } catch (error) {
                console.error('Error opening modal:', error);
                this.showError('Could not open settings');
                this.isTransitioning = false;
            }
        },
        
        close(modalId, forceClose = false) {
            try {
                // Debounce to prevent double-clicks
                if (this.closeDebounceTimer && !forceClose) {
                    return;
                }
                
                const modal = document.getElementById(modalId || this.activeModal?.id);
                if (!modal) {
                    console.warn('No modal to close');
                    return;
                }
                
                // Set debounce timer
                this.closeDebounceTimer = setTimeout(() => {
                    this.closeDebounceTimer = null;
                }, 300);
                
                // Hide modal
                modal.classList.remove('show');
                modal.setAttribute('aria-hidden', 'true');
                
                // Restore body scroll
                document.body.style.overflow = '';
                
                // Restore previous focus with fallback
                setTimeout(() => {
                    try {
                        if (this.previousFocus && document.body.contains(this.previousFocus)) {
                            this.previousFocus.focus();
                        } else {
                            // Fallback: focus settings button if previous focus is invalid
                            const settingsBtn = document.querySelector('[onclick*="toggleSettingsModal"]');
                            if (settingsBtn) settingsBtn.focus();
                        }
                    } catch (e) {
                        console.warn('Could not restore focus:', e);
                    }
                    this.previousFocus = null;
                }, 100);
                
                // Clear active modal
                this.activeModal = null;
                
                // Remove event listeners
                this.removeEventListeners(modal);
            } catch (error) {
                console.error('Error closing modal:', error);
                // Force close as fallback
                if (!forceClose) {
                    try {
                        const modal = document.getElementById(modalId || 'settingsModal');
                        if (modal) {
                            modal.classList.remove('show');
                            modal.setAttribute('aria-hidden', 'true');
                        }
                        document.body.style.overflow = '';
                        this.activeModal = null;
                    } catch (fallbackError) {
                        console.error('Fallback close also failed:', fallbackError);
                    }
                }
            }
        },
        
        addEventListeners(modal) {
            try {
                // ESC key handler
                modal._escHandler = (e) => {
                    if (e.key === 'Escape' || e.key === 'Esc') {
                        e.preventDefault();
                        this.close(modal.id);
                    }
                };
                document.addEventListener('keydown', modal._escHandler, { passive: false });
                
                // Click outside handler
                modal._clickOutsideHandler = (e) => {
                    if (e.target === modal) {
                        this.close(modal.id);
                    }
                };
                modal.addEventListener('click', modal._clickOutsideHandler);
                
                // Focus trap
                modal._focusTrapHandler = (e) => {
                    if (e.key === 'Tab') {
                        try {
                            const focusable = modal.querySelectorAll(
                                'button:not([disabled]), [href]:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"]):not([disabled])'
                            );
                            const focusableArray = Array.from(focusable);
                            const first = focusableArray[0];
                            const last = focusableArray[focusableArray.length - 1];
                            
                            if (focusableArray.length === 0) return;
                            
                            if (e.shiftKey && document.activeElement === first) {
                                e.preventDefault();
                                last.focus();
                            } else if (!e.shiftKey && document.activeElement === last) {
                                e.preventDefault();
                                first.focus();
                            }
                        } catch (err) {
                            console.warn('Focus trap error:', err);
                        }
                    }
                };
                modal.addEventListener('keydown', modal._focusTrapHandler, { passive: false });
            } catch (error) {
                console.error('Error adding event listeners:', error);
            }
        },
        
        removeEventListeners(modal) {
            try {
                if (modal._escHandler) {
                    document.removeEventListener('keydown', modal._escHandler);
                    delete modal._escHandler;
                }
                if (modal._clickOutsideHandler) {
                    modal.removeEventListener('click', modal._clickOutsideHandler);
                    delete modal._clickOutsideHandler;
                }
                if (modal._focusTrapHandler) {
                    modal.removeEventListener('keydown', modal._focusTrapHandler);
                    delete modal._focusTrapHandler;
                }
            } catch (error) {
                console.warn('Error removing event listeners:', error);
            }
        },
        
        showError(message) {
            // Simple error notification
            const errorDiv = document.createElement('div');
            errorDiv.textContent = message;
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #ef4444;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.75rem;
                box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
                z-index: 99999;
                font-weight: 600;
                animation: slideInRight 0.3s ease;
            `;
            document.body.appendChild(errorDiv);
            setTimeout(() => {
                errorDiv.style.opacity = '0';
                errorDiv.style.transform = 'translateX(100%)';
                errorDiv.style.transition = 'all 0.3s ease';
                setTimeout(() => errorDiv.remove(), 300);
            }, 3000);
        }
    };
    
    function toggleSettingsModal() {
        try {
            const modal = document.getElementById('settingsModal');
            if (!modal) {
                console.error('Settings modal not found');
                modalManager.showError('Settings panel not available');
                return;
            }
            
            if (modal.classList.contains('show')) {
                modalManager.close('settingsModal');
            } else {
                modalManager.open('settingsModal');
            }
        } catch (error) {
            console.error('Error toggling settings modal:', error);
            modalManager.showError('Could not open settings');
        }
    }
    
    // Ensure modal manager is available globally
    window.modalManager = modalManager;
    window.toggleSettingsModal = toggleSettingsModal;
    
    // Initialize modal on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
        const settingsModal = document.getElementById('settingsModal');
        if (settingsModal) {
            // Set initial ARIA attributes
            settingsModal.setAttribute('aria-hidden', 'true');
            
            // Add touch support for mobile
            const closeBtn = settingsModal.querySelector('.modal-close');
            if (closeBtn) {
                // Prevent double-tap zoom on iOS
                closeBtn.style.touchAction = 'manipulation';
                
                // Add visual feedback on touch
                closeBtn.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                }, { passive: true });
                
                closeBtn.addEventListener('touchend', function() {
                    this.style.transform = '';
                }, { passive: true });
            }
        }
    });
    
    async function confirmDelete(event, form) {
        event.preventDefault();
        try {
            const confirmed = await confirmAction('Are you sure you want to delete this task?', 'Delete Task');
            if (confirmed) {
                form.submit();
            }
        } catch (error) {
            console.error('Delete confirmation error:', error);
            showError('Unable to process deletion. Please try again.');
        }
        return false;
    }
    
    function handleEditClick(event, taskId) {
        try {
            // Allow default navigation, but add error handling
            if (!taskId || taskId <= 0) {
                event.preventDefault();
                showError('Invalid task ID. Unable to load task for editing.');
                return false;
            }
            // Let the browser handle navigation naturally
            return true;
        } catch (error) {
            event.preventDefault();
            console.error('Edit navigation error:', error);
            showError('Unable to load task for editing. Please try again.');
            return false;
        }
    }
    
    // Budget increment/decrement buttons
    document.addEventListener('DOMContentLoaded', () => {
        const budgetInput = document.getElementById('budgetInput');
        const decrementBtn = document.getElementById('decrementBudget');
        const incrementBtn = document.getElementById('incrementBudget');
        
        if (budgetInput && decrementBtn && incrementBtn) {
            decrementBtn.addEventListener('click', () => {
                let value = parseInt(budgetInput.value) || 100;
                value = Math.max(10, value - 5);
                budgetInput.value = value;
                markFormAsModified();
            });
            
            incrementBtn.addEventListener('click', () => {
                let value = parseInt(budgetInput.value) || 100;
                value = Math.min(500, value + 5);
                budgetInput.value = value;
                markFormAsModified();
            });
        }
        
        // Track form changes
        const settingsForm = document.querySelector('#settingsModal form');
        if (settingsForm) {
            settingsForm.addEventListener('input', markFormAsModified);
            settingsForm.addEventListener('change', markFormAsModified);
            
            // Reset modified flag on submit
            settingsForm.addEventListener('submit', () => {
                delete settingsForm.dataset.modified;
            });
        }
        
        // Enhanced Category Tab Interactions
        const categoryTabs = document.querySelectorAll('.category-tab a');
        categoryTabs.forEach(tab => {
            // Smooth transition on click
            tab.addEventListener('click', (e) => {
                // Add loading state
                const taskContainer = document.getElementById('taskListContainer');
                if (taskContainer) {
                    taskContainer.style.opacity = '0.6';
                    taskContainer.style.transition = 'opacity 0.2s ease';
                    
                    // Restore opacity after navigation starts
                    setTimeout(() => {
                        taskContainer.style.opacity = '1';
                    }, 200);
                }
            });
            
            // Keyboard navigation (arrow keys)
            tab.addEventListener('keydown', (e) => {
                const tabs = Array.from(categoryTabs);
                const currentIndex = tabs.indexOf(tab);
                
                if (e.key === 'ArrowRight' && currentIndex < tabs.length - 1) {
                    e.preventDefault();
                    tabs[currentIndex + 1].focus();
                } else if (e.key === 'ArrowLeft' && currentIndex > 0) {
                    e.preventDefault();
                    tabs[currentIndex - 1].focus();
                }
            });
        });
        
        // Re-initialize lucide icons after page load
        lucide.createIcons();
    });
    
    function markFormAsModified() {
        const form = document.querySelector('#settingsModal form');
        if (form) {
            form.dataset.modified = 'true';
        }
    }
</script>